أكيد — ده الكود كامل (انسخه والصقه في ملف اسمه index.html وشغّله مباشرة):

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>برو تشيكس | نظام إدارة التوزيع</title>

  <!-- Arabic Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { font-family: Cairo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    button, a, input, select { touch-action: manipulation; }
  </style>
</head>

<body class="bg-slate-100">
  <div id="root"></div>

  <!-- React + ReactDOM (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (to allow JSX directly in this HTML file) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    /***********************
     * Inline SVG Icons
     ***********************/
    const ICONS = {
      menu: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg>),
      x: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>),
      logout: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>),
      dashboard: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="8" height="8" rx="2"/><rect x="13" y="3" width="8" height="5" rx="2"/><rect x="13" y="10" width="8" height="11" rx="2"/><rect x="3" y="13" width="8" height="8" rx="2"/></svg>),
      cart: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="20" r="1"/><circle cx="17" cy="20" r="1"/><path d="M3 4h2l2.2 10.5a2 2 0 0 0 2 1.5h7.6a2 2 0 0 0 2-1.6L21 7H6"/></svg>),
      truck: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7h11v10H3z"/><path d="M14 10h4l3 3v4h-7z"/><circle cx="7" cy="19" r="1.5"/><circle cx="18" cy="19" r="1.5"/></svg>),
      users: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="3"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a3 3 0 0 1 0 5.74"/></svg>),
      receipt: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2h12v20l-2-1-2 1-2-1-2 1-2-1-2 1z"/><path d="M9 6h6"/><path d="M9 10h6"/><path d="M9 14h6"/></svg>),
      plus: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>),
      package: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 8l-9 5-9-5"/><path d="M3 8V16l9 5 9-5V8"/><path d="M12 13v8"/></svg>),
      wallet: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 7h18v14H3z"/><path d="M3 7a2 2 0 0 1 2-2h14v2H5a2 2 0 0 0-2 2z"/><path d="M17 13h4"/><circle cx="17" cy="13" r="0.5" fill="currentColor"/></svg>),
      trash: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M19 6l-1 16H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>),
      tag: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.59 13.41 11 3H4v7l9.59 9.59a2 2 0 0 0 2.82 0l4.18-4.18a2 2 0 0 0 0-2.82z"/><circle cx="7.5" cy="7.5" r="1"/></svg>),
      printer: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9V4h12v5"/><path d="M6 18h12v2H6z"/><path d="M6 14h12v4H6z"/><path d="M6 13H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"/></svg>),
      lock: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>),
      settings: (p) => (<svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/><circle cx="12" cy="12" r="3"/></svg>),
    };

    function Icon({ name, size = 20, className = "" }) {
      const Comp = ICONS[name];
      if (!Comp) return null;
      return <Comp width={size} height={size} className={className} />;
    }

    function toNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function formatMoney(n){ return toNumber(n).toLocaleString("ar-EG"); }
    function formatQty(n){ return toNumber(n).toLocaleString("ar-EG"); }
    function computeDebt(total, paid){ return Math.max(toNumber(total) - toNumber(paid), 0); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function useLocalStorageState(key, initialValue){
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
        catch { return initialValue; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    /***********************
     * Auth + Roles
     ***********************/
    const DEFAULT_USERS = [
      { id: 1, username: "admin", displayName: "المدير", pin: "1234", role: "admin" },
      { id: 2, username: "ali", displayName: "علي عبدالله", pin: "0000", role: "clerk" },
    ];
    const ROLE_TABS = {
      admin: ["dashboard","products","purchases","sales","receipts","settlements","expenses","settings"],
      clerk: ["purchases","sales","expenses","receipts","settings"],
    };
    function canSeeTab(role, tabId){
      const allowed = ROLE_TABS[role] || [];
      return allowed.includes(tabId);
    }

    /***********************
     * Printing
     ***********************/
    function printReceiptHTML({ title, companyName, date, customer, driver, items, totals, notes }) {
      const rowsHtml = items.map((it, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(it.product)}</td>
          <td>${escapeHtml(it.unit || "")}</td>
          <td>${escapeHtml(it.quantity)}</td>
          <td>${escapeHtml(it.price)}</td>
          <td><b>${escapeHtml(it.total)}</b></td>
        </tr>
      `).join("");

      const html = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${escapeHtml(title)}</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    *{box-sizing:border-box}
    body{font-family:Cairo,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#fff;color:#0f172a}
    .wrap{max-width:820px;margin:24px auto;padding:24px;border:1px solid #e2e8f0;border-radius:16px}
    .top{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;border-bottom:1px solid #e2e8f0;padding-bottom:16px}
    .brand h1{margin:0;font-size:22px}
    .brand p{margin:6px 0 0;color:#64748b;font-weight:700}
    .meta{min-width:260px}
    .meta .box{background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:12px}
    .meta .row{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .meta .k{color:#64748b;font-weight:800}
    .meta .v{font-weight:900}
    h2{margin:18px 0 12px;font-size:18px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #e2e8f0;padding:10px;text-align:right}
    th{background:#f1f5f9;color:#334155;font-weight:900}
    .totals{margin-top:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .tbox{background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:12px}
    .tbox .k{color:#64748b;font-weight:900;font-size:12px}
    .tbox .v{font-weight:900;font-size:16px;margin-top:4px}
    .sign{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .line{height:44px;border-bottom:2px dashed #cbd5e1}
    .foot{margin-top:14px;color:#64748b;font-weight:800;font-size:12px}
    @media print {
      body{margin:0}
      .wrap{border:none;margin:0;max-width:none;border-radius:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>${escapeHtml(companyName || "برو تشيكس")}</h1>
        <p>${escapeHtml(title)}</p>
      </div>
      <div class="meta">
        <div class="box">
          <div class="row"><span class="k">التاريخ</span><span class="v">${escapeHtml(date || "—")}</span></div>
          <div class="row"><span class="k">العميل</span><span class="v">${escapeHtml(customer || "—")}</span></div>
          <div class="row"><span class="k">الموزع</span><span class="v">${escapeHtml(driver || "—")}</span></div>
        </div>
      </div>
    </div>

    <h2>تفاصيل الأصناف</h2>
    <table>
      <thead>
        <tr>
          <th style="width:46px">#</th>
          <th>المنتج</th>
          <th style="width:90px">الوحدة</th>
          <th style="width:110px">الكمية</th>
          <th style="width:120px">السعر</th>
          <th style="width:140px">الإجمالي</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>

    <div class="totals">
      <div class="tbox"><div class="k">إجمالي الفاتورة</div><div class="v">${escapeHtml(totals.total || "0")} ج</div></div>
      <div class="tbox"><div class="k">المحصل</div><div class="v">${escapeHtml(totals.paid || "0")} ج</div></div>
      <div class="tbox"><div class="k">المتبقي (آجل)</div><div class="v">${escapeHtml(totals.debt || "0")} ج</div></div>
    </div>

    <div class="totals" style="grid-template-columns:1fr">
      <div class="tbox"><div class="k">ملاحظات</div><div class="v" style="font-size:14px">${escapeHtml(notes || "—")}</div></div>
    </div>

    <div class="sign">
      <div>
        <div class="k" style="color:#64748b;font-weight:900;margin-bottom:8px">توقيع العميل</div>
        <div class="line"></div>
      </div>
      <div>
        <div class="k" style="color:#64748b;font-weight:900;margin-bottom:8px">توقيع الشركة</div>
        <div class="line"></div>
      </div>
    </div>

    <div class="foot">تم إصدار هذا الإيصال من النظام — للطباعة اضغط Print.</div>
  </div>

  <script>
    window.addEventListener('load', () => setTimeout(() => window.print(), 200));
  </script>
</body>
</html>`;

      const w = window.open("", "_blank");
      if (!w) { alert("المتصفح منع نافذة الطباعة. فعل Pop-ups أو جرّب Chrome."); return; }
      w.document.open(); w.document.write(html); w.document.close(); w.focus();
    }

    /***********************
     * UI helpers
     ***********************/
    const Card = ({ children, className = "" }) => (
      <div className={"bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-100 " + className}>{children}</div>
    );
    const Notice = ({ variant="info", children }) => {
      const styles =
        variant === "info" ? "bg-blue-50 border-blue-200 text-blue-900" :
        variant === "warn" ? "bg-orange-50 border-orange-200 text-orange-900" :
        "bg-red-50 border-red-200 text-red-900";
      return <div className={`border p-4 rounded-xl ${styles}`}>{children}</div>;
    };
    const Field = ({ label, children, className="" }) => (
      <div className={"flex flex-col gap-1 " + className}>
        <label className="text-xs text-slate-500 font-black">{label}</label>
        {children}
      </div>
    );
    const Input = (props) => (
      <input {...props} className={"border border-slate-200 bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300 transition w-full " + (props.className||"")} />
    );
    const Select = (props) => (
      <select {...props} className={"border border-slate-200 bg-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-300 transition w-full " + (props.className||"")} />
    );
    const Button = ({ variant="primary", className="", children, ...props }) => {
      const base = "px-4 py-3 rounded-xl font-black transition inline-flex items-center justify-center gap-2 w-full sm:w-auto";
      const styles =
        variant === "primary" ? "bg-blue-600 text-white hover:bg-blue-700" :
        variant === "success" ? "bg-emerald-600 text-white hover:bg-emerald-700" :
        variant === "danger" ? "bg-red-500 text-white hover:bg-red-600" :
        "bg-slate-100 text-slate-900 hover:bg-slate-200";
      return <button {...props} className={`${base} ${styles} ${className}`}>{children}</button>;
    };
    const SmallBtn = ({ className="", ...props }) => (
      <button {...props} className={"p-2 rounded-lg hover:bg-slate-100 transition " + className} />
    );
    const TabBtn = ({ active, icon, label, onClick }) => (
      <button onClick={onClick} className={"flex items-center gap-2 px-4 py-3 rounded-xl font-black transition w-full text-right " + (active ? "bg-blue-600 text-white" : "text-slate-700 hover:bg-blue-50 hover:text-blue-700")}>
        <Icon name={icon} size={18} />
        <span>{label}</span>
      </button>
    );

    /***********************
     * App
     ***********************/
    function App(){
      const [menuOpen, setMenuOpen] = useState(false);

      const [users, setUsers] = useLocalStorageState("pc_users", DEFAULT_USERS);
      const [currentUser, setCurrentUser] = useLocalStorageState("pc_current_user", null);

      const [loginUsername, setLoginUsername] = useState("");
      const [loginPin, setLoginPin] = useState("");
      const [loginErr, setLoginErr] = useState("");

      const [activeTab, setActiveTab] = useState("sales"); // start simple
      const [filterDate, setFilterDate] = useState(""); // manual filter (admin)

      // Master data
      const [products, setProducts] = useLocalStorageState("pc_products", [
        { id: 1, category:"كتاكيت", name:"كتكوت أبيض", unit:"كتكوت" },
        { id: 2, category:"كتاكيت", name:"كتكوت ساسو", unit:"كتكوت" },
        { id: 3, category:"كتاكيت", name:"كتكوت بلدي", unit:"كتكوت" },
      ]);
      const [suppliers, setSuppliers] = useLocalStorageState("pc_suppliers", [{ id:1, name:"معمل الوطنية" }]);
      const [customers, setCustomers] = useLocalStorageState("pc_customers", [
        { id:1, name:"مزرعة الأمل" },
        { id:2, name:"محل طيور البركة" },
        { id:3, name:"Alamal Group" },
      ]);
      const [drivers, setDrivers] = useLocalStorageState("pc_drivers", [
        { id:1, name:"سيد محمود" },
        { id:2, name:"أحمد علي" },
      ]);

      // Ops
      const [purchases, setPurchases] = useLocalStorageState("pc_purchases", []);
      const [sales, setSales] = useLocalStorageState("pc_sales", []);
      const [expenses, setExpenses] = useLocalStorageState("pc_expenses", []);

      // Forms
      const [purchaseForm, setPurchaseForm] = useState({ date:"", supplier:suppliers[0]?.name||"", product:products[0]?.name||"", quantity:"", buyPrice:"", paid:"", loss:"0", notes:"" });
      const [saleForm, setSaleForm] = useState({ date:"", customer:customers[0]?.name||"", driver:drivers[0]?.name||"", product:products[0]?.name||"", quantity:"", sellPrice:"", paid:"", notes:"" });
      const [expenseForm, setExpenseForm] = useState({ date:"", category:"", driver:"", amount:"", notes:"" });

      const [err, setErr] = useState({ purchase:"", sale:"", expense:"", admin:"" });

      const productUnit = (name) => products.find(p => p.name === name)?.unit || "";

      // Ensure tabs allowed
      useEffect(() => {
        if (currentUser && !canSeeTab(currentUser.role, activeTab)) {
          setActiveTab(ROLE_TABS[currentUser.role]?.[0] || "sales");
        }
      }, [currentUser]);

      // Stock
      const stockByProduct = useMemo(() => {
        const map = {};
        products.forEach(p => map[p.name] = 0);
        purchases.forEach(p => { map[p.product] = (map[p.product]||0) + toNumber(p.quantity) - toNumber(p.loss||0); });
        sales.forEach(s => { map[s.product] = (map[s.product]||0) - toNumber(s.quantity); });
        return map;
      }, [products, purchases, sales]);
      const totalStock = useMemo(() => Object.values(stockByProduct).reduce((a,b)=>a+toNumber(b),0), [stockByProduct]);

      // Admin KPI
      const kpis = useMemo(() => {
        const owedToSuppliers = purchases.reduce((sum,p)=>sum+toNumber(p.debt),0);
        const owedFromCustomers = sales.reduce((sum,s)=>sum+toNumber(s.debt),0);
        const salesValue = sales.reduce((sum,s)=>sum+toNumber(s.total),0);
        const expensesValue = expenses.reduce((sum,e)=>sum+toNumber(e.amount),0);

        const purchasedQty = purchases.reduce((sum,p)=>sum+toNumber(p.quantity),0);
        const purchaseValue = purchases.reduce((sum,p)=>sum+toNumber(p.total),0);
        const avgBuy = purchasedQty>0 ? purchaseValue/purchasedQty : 0;

        const soldQty = sales.reduce((sum,s)=>sum+toNumber(s.quantity),0);
        const estProfit = salesValue - (soldQty*avgBuy) - expensesValue;

        const todaySales = filterDate ? sales.filter(s => s.date === filterDate).reduce((sum,s)=>sum+toNumber(s.total),0) : 0;
        return { owedToSuppliers, owedFromCustomers, estProfit, todaySales };
      }, [purchases, sales, expenses, filterDate]);

      // Settlements (admin, per filterDate)
      const settlements = useMemo(() => {
        if (!filterDate) return [];
        const map = {};
        sales.filter(s=>s.date===filterDate).forEach(s=>{
          map[s.driver] ||= { name:s.driver, cash:0, expenses:0, total:0, qty:0, debt:0 };
          map[s.driver].cash += toNumber(s.paid);
          map[s.driver].total += toNumber(s.total);
          map[s.driver].qty += toNumber(s.quantity);
          map[s.driver].debt += toNumber(s.debt);
        });
        expenses.filter(e=>e.date===filterDate).forEach(e=>{
          if (!e.driver) return;
          map[e.driver] ||= { name:e.driver, cash:0, expenses:0, total:0, qty:0, debt:0 };
          map[e.driver].expenses += toNumber(e.amount);
        });
        return Object.values(map).map(d => ({...d, net: d.cash - d.expenses}));
      }, [sales, expenses, filterDate]);

      // Receipt
      const [receiptDate, setReceiptDate] = useState("");
      const [receiptCustomer, setReceiptCustomer] = useState(customers[0]?.name || "");
      const [receiptDriver, setReceiptDriver] = useState("");
      const [receiptNotes, setReceiptNotes] = useState("");
      const [receiptPreview, setReceiptPreview] = useState(null);
      const [receiptErr, setReceiptErr] = useState("");

      function login(){
        setLoginErr("");
        const u = users.find(x => x.username.toLowerCase() === (loginUsername||"").trim().toLowerCase());
        if (!u) return setLoginErr("المستخدم غير موجود.");
        if ((loginPin||"").trim() !== u.pin) return setLoginErr("PIN غير صحيح.");
        setCurrentUser({ id:u.id, username:u.username, displayName:u.displayName, role:u.role });
        setActiveTab(u.role==="clerk" ? "sales" : "dashboard");
        setMenuOpen(false);
      }
      function logout(){ setCurrentUser(null); setActiveTab("sales"); setMenuOpen(false); }

      function addPurchase(){
        setErr(e=>({...e,purchase:""}));
        const date = (purchaseForm.date||"").trim();
        const supplier = (purchaseForm.supplier||"").trim();
        const product = (purchaseForm.product||"").trim();
        const quantity = toNumber(purchaseForm.quantity);
        const buyPrice = toNumber(purchaseForm.buyPrice);
        const paid = toNumber(purchaseForm.paid);
        const loss = Math.max(0, Math.min(toNumber(purchaseForm.loss), quantity));

        if(!date||!supplier||!product||quantity<=0||buyPrice<=0){
          return setErr(e=>({...e,purchase:"املأ: التاريخ + المعمل + المنتج + الكمية + سعر الشراء."}));
        }
        const total = quantity*buyPrice;
        const debt = computeDebt(total, paid);

        const row = { id:Date.now(), createdBy:currentUser?.displayName||"—", date,supplier,product,quantity,buyPrice,total,paid,debt,loss,notes:purchaseForm.notes||"" };
        setPurchases(prev => [row, ...prev]);
        setPurchaseForm(f=>({...f,quantity:"",buyPrice:"",paid:"",loss:"0",notes:""}));
      }

      function addSale(){
        setErr(e=>({...e,sale:""}));
        const date = (saleForm.date||"").trim();
        const customer = (saleForm.customer||"").trim();
        const driver = (saleForm.driver||"").trim();
        const product = (saleForm.product||"").trim();
        const quantity = toNumber(saleForm.quantity);
        const sellPrice = toNumber(saleForm.sellPrice);
        const paid = toNumber(saleForm.paid);

        if(!date||!customer||!driver||!product||quantity<=0||sellPrice<=0){
          return setErr(e=>({...e,sale:"املأ: التاريخ + العميل + الموزع + المنتج + الكمية + سعر البيع."}));
        }
        const available = toNumber(stockByProduct[product]||0);
        if(quantity>available){
          return setErr(e=>({...e,sale:`المخزون غير كافي (${product}). المتاح: ${formatQty(available)}.`}));
        }
        const total = quantity*sellPrice;
        const debt = computeDebt(total, paid);

        const row = { id:Date.now(), createdBy:currentUser?.displayName||"—", date,customer,driver,product,quantity,sellPrice,total,paid,debt,notes:saleForm.notes||"" };
        setSales(prev => [row, ...prev]);
        setSaleForm(f=>({...f,quantity:"",sellPrice:"",paid:"",notes:""}));
      }

      function addExpense(){
        setErr(e=>({...e,expense:""}));
        const date = (expenseForm.date||"").trim();
        const category = (expenseForm.category||"").trim();
        const driver = (expenseForm.driver||"").trim();
        const amount = toNumber(expenseForm.amount);
        if(!date||!category||amount<=0){
          return setErr(e=>({...e,expense:"املأ: التاريخ + نوع المصروف + مبلغ صحيح."}));
        }
        const row = { id:Date.now(), createdBy:currentUser?.displayName||"—", date,category,driver:driver||"",amount,notes:expenseForm.notes||"" };
        setExpenses(prev => [row, ...prev]);
        setExpenseForm({ date:"",category:"",driver:"",amount:"",notes:"" });
      }

      function removeRow(kind, id){
        if(!confirm("حذف السطر؟")) return;
        if(kind==="purchase") setPurchases(p=>p.filter(x=>x.id!==id));
        if(kind==="sale") setSales(p=>p.filter(x=>x.id!==id));
        if(kind==="expense") setExpenses(p=>p.filter(x=>x.id!==id));
      }

      function buildReceipt(){
        setReceiptErr(""); setReceiptPreview(null);
        const d = (receiptDate||"").trim();
        const c = (receiptCustomer||"").trim();
        const drv = (receiptDriver||"").trim();
        if(!d||!c) return setReceiptErr("اختار التاريخ + العميل.");

        const list = sales
          .filter(s=>s.date===d)
          .filter(s=>s.customer===c)
          .filter(s=>drv ? s.driver===drv : true);

        if(list.length===0) return setReceiptErr("مفيش عمليات بيع مطابقة.");

        const items = list.map(s=>({
          product:s.product,
          unit:productUnit(s.product),
          quantity:formatQty(s.quantity),
          price:`${formatMoney(s.sellPrice)} ج`,
          total:`${formatMoney(s.total)} ج`,
        }));

        const total = list.reduce((sum,s)=>sum+toNumber(s.total),0);
        const paid = list.reduce((sum,s)=>sum+toNumber(s.paid),0);
        const debt = list.reduce((sum,s)=>sum+toNumber(s.debt),0);

        const driverLabel = drv || (Array.from(new Set(list.map(x=>x.driver))).length===1 ? list[0].driver : "متعدد");

        setReceiptPreview({
          title:"إيصال بيع",
          companyName:"برو تشيكس",
          date:d,
          customer:c,
          driver:driverLabel,
          items,
          totals:{ total:formatMoney(total), paid:formatMoney(paid), debt:formatMoney(debt) },
          notes:receiptNotes
        });
      }

      function printReceipt(){
        if(!receiptPreview) return;
        printReceiptHTML(receiptPreview);
      }

      // Pin change (admin)
      const [pinEdit, setPinEdit] = useState({ username:"ali", newPin:"" });
      function changePin(){
        if(currentUser?.role!=="admin") return;
        setErr(e=>({...e,admin:""}));
        const uname = (pinEdit.username||"").trim().toLowerCase();
        const np = (pinEdit.newPin||"").trim();
        if(np.length<4) return setErr(e=>({...e,admin:"PIN لازم يكون 4 أرقام أو أكتر."}));
        setUsers(prev => prev.map(u => u.username.toLowerCase()===uname ? ({...u, pin:np}) : u));
        setPinEdit(p=>({...p,newPin:""}));
      }

      if(!currentUser){
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="w-full max-w-md bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-3 rounded-xl bg-blue-600 text-white"><Icon name="lock" size={22}/></div>
                <div>
                  <h1 className="text-xl font-black text-slate-900">تسجيل الدخول</h1>
                  <p className="text-xs text-slate-500 font-bold">صلاحيات مختلفة لكل موظف</p>
                </div>
              </div>

              {loginErr && <Notice variant="warn"><div className="font-black">{loginErr}</div></Notice>}

              <div className="grid gap-3 mt-4">
                <Field label="Username">
                  <Input value={loginUsername} onChange={(e)=>setLoginUsername(e.target.value)} placeholder="admin أو ali" />
                </Field>
                <Field label="PIN">
                  <Input value={loginPin} onChange={(e)=>setLoginPin(e.target.value)} type="password" inputMode="numeric" placeholder="••••" />
                </Field>
                <Button onClick={login}><Icon name="lock" size={18}/> دخول</Button>
              </div>

              <div className="mt-4 bg-slate-50 border border-slate-200 rounded-xl p-3">
                <p className="text-xs text-slate-600 font-black">حسابات افتراضية:</p>
                <ul className="text-xs text-slate-700 font-bold mt-1 list-disc pr-5">
                  <li>admin / 1234 (مدير)</li>
                  <li>ali / 0000 (علي عبدالله - إدخال بيانات فقط)</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      const nav = [
        { id:"dashboard", icon:"dashboard", label:"لوحة التحكم" },
        { id:"products", icon:"tag", label:"المنتجات" },
        { id:"purchases", icon:"cart", label:"المشتريات" },
        { id:"sales", icon:"truck", label:"المبيعات" },
        { id:"receipts", icon:"printer", label:"الإيصالات" },
        { id:"settlements", icon:"users", label:"تقفيل اليومية" },
        { id:"expenses", icon:"receipt", label:"المصروفات" },
        { id:"settings", icon:"settings", label:"الإعدادات" },
      ].filter(t => canSeeTab(currentUser.role, t.id));

      const titleByTab = {
        dashboard:"نظرة عامة",
        products:"المنتجات",
        purchases:"المشتريات",
        sales:"المبيعات",
        receipts:"الإيصالات",
        settlements:"تقفيل اليومية",
        expenses:"المصروفات",
        settings:"الإعدادات",
      };

      function goTab(id){ setActiveTab(id); setMenuOpen(false); }

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-30 bg-white border-b border-slate-200">
            <div className="px-4 py-3 flex items-center justify-between gap-3">
              <div className="flex items-center gap-2">
                <button className="p-2 rounded-xl hover:bg-slate-100 lg:hidden" onClick={()=>setMenuOpen(v=>!v)} aria-label="Menu">
                  <Icon name={menuOpen ? "x" : "menu"} size={22}/>
                </button>
                <div className="flex items-center gap-2">
                  <div className="p-2 rounded-xl bg-blue-600 text-white"><Icon name="package" size={18}/></div>
                  <div>
                    <div className="font-black text-slate-900 leading-5">برو تشيكس</div>
                    <div className="text-xs text-slate-500 font-bold">{titleByTab[activeTab] || ""}</div>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <div className="hidden sm:flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                  <span className="text-xs text-slate-500 font-black">المخزون</span>
                  <span className="font-black text-slate-900">{formatQty(totalStock)}</span>
                </div>
                <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                  <span className="font-black text-slate-900">{currentUser.displayName}</span>
                </div>
                <button className="p-2 rounded-xl hover:bg-slate-100" onClick={logout} title="خروج">
                  <Icon name="logout" size={20} className="text-slate-700"/>
                </button>
              </div>
            </div>

            {currentUser.role==="admin" && (
              <div className="px-4 pb-3">
                <div className="flex flex-col sm:flex-row sm:items-end gap-2">
                  <div className="flex-1">
                    <Field label="فلتر بالتاريخ (لليومية/المبيعات)">
                      <Input type="date" value={filterDate} onChange={(e)=>setFilterDate(e.target.value)} />
                    </Field>
                  </div>
                  <div className="sm:w-auto">
                    <Button variant="secondary" onClick={()=>setFilterDate("")}>مسح الفلتر</Button>
                  </div>
                </div>
              </div>
            )}
          </header>

          {menuOpen && (
            <div className="fixed inset-0 z-40 lg:hidden" onClick={()=>setMenuOpen(false)}>
              <div className="absolute inset-0 bg-black/30"></div>
              <div className="absolute top-0 right-0 h-full w-80 max-w-[85%] bg-white border-l border-slate-200 p-4 overflow-auto" onClick={(e)=>e.stopPropagation()}>
                <div className="flex items-center justify-between mb-3">
                  <div className="font-black text-slate-900">القائمة</div>
                  <button className="p-2 rounded-xl hover:bg-slate-100" onClick={()=>setMenuOpen(false)}><Icon name="x" size={20}/></button>
                </div>
                <div className="space-y-2">
                  {nav.map(t => <TabBtn key={t.id} active={activeTab===t.id} icon={t.icon} label={t.label} onClick={()=>goTab(t.id)} />)}
                </div>
                <div className="mt-4 text-xs text-slate-500 font-bold">
                  صلاحيات: {currentUser.role==="admin" ? "مدير" : "إدخال بيانات فقط"}
                </div>
              </div>
            </div>
          )}

          <div className="lg:flex">
            <aside className="hidden lg:block w-80 bg-white border-l border-slate-200 min-h-[calc(100vh-64px)] sticky top-[64px] p-4">
              <div className="space-y-2">
                {nav.map(t => <TabBtn key={t.id} active={activeTab===t.id} icon={t.icon} label={t.label} onClick={()=>goTab(t.id)} />)}
              </div>
              <div className="mt-4 bg-slate-50 border border-slate-200 rounded-xl p-3">
                <p className="text-xs text-slate-600 font-black">المخزون الحالي</p>
                <p className="text-2xl font-black text-slate-900">{formatQty(totalStock)}</p>
              </div>
            </aside>

            <main className="flex-1 p-4 sm:p-6 space-y-4">
              {activeTab==="dashboard" && currentUser.role==="admin" && (
                <div className="space-y-4">
                  <Notice variant="info"><div className="font-black">لوحة التحكم للمدير فقط.</div></Notice>
                  <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                    <Card><div className="text-xs text-slate-500 font-black">المخزون</div><div className="text-2xl font-black">{formatQty(totalStock)}</div></Card>
                    <Card><div className="text-xs text-slate-500 font-black">{filterDate ? `مبيعات (${filterDate})` : "مبيعات (اختر فلتر)"}</div><div className="text-2xl font-black">{formatMoney(kpis.todaySales)} ج</div></Card>
                    <Card><div className="text-xs text-slate-500 font-black">ديون لنا (عند العملاء)</div><div className="text-2xl font-black">{formatMoney(kpis.owedFromCustomers)} ج</div></Card>
                    <Card><div className="text-xs text-slate-500 font-black">ديون علينا (للمعامل)</div><div className="text-2xl font-black">{formatMoney(kpis.owedToSuppliers)} ج</div></Card>
                  </div>
                  <Card><div className="text-xs text-slate-500 font-black">ربح تقديري (كل الفترة)</div><div className="text-3xl font-black text-emerald-700">{formatMoney(kpis.estProfit)} ج</div></Card>
                </div>
              )}

              {activeTab==="purchases" && (
                <div className="space-y-4">
                  <Card>
                    <div className="font-black text-slate-900 flex items-center gap-2"><Icon name="cart" size={18}/> تسجيل استلامة</div>
                    {err.purchase && <Notice variant="warn"><div className="font-black">{err.purchase}</div></Notice>}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-3">
                      <Field label="التاريخ"><Input type="date" value={purchaseForm.date} onChange={(e)=>setPurchaseForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="المعمل">
                        <Select value={purchaseForm.supplier} onChange={(e)=>setPurchaseForm(f=>({...f,supplier:e.target.value}))}>
                          {suppliers.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="المنتج">
                        <Select value={purchaseForm.product} onChange={(e)=>setPurchaseForm(f=>({...f,product:e.target.value}))}>
                          {products.map(p => <option key={p.id} value={p.name}>{p.name} ({p.unit})</option>)}
                        </Select>
                      </Field>
                      <Field label={`الكمية (${productUnit(purchaseForm.product)})`}><Input type="number" value={purchaseForm.quantity} onChange={(e)=>setPurchaseForm(f=>({...f,quantity:e.target.value}))} placeholder="10000"/></Field>
                      <Field label="سعر الشراء / وحدة"><Input type="number" step="0.01" value={purchaseForm.buyPrice} onChange={(e)=>setPurchaseForm(f=>({...f,buyPrice:e.target.value}))} placeholder="25"/></Field>
                      <Field label="المدفوع"><Input type="number" step="0.01" value={purchaseForm.paid} onChange={(e)=>setPurchaseForm(f=>({...f,paid:e.target.value}))} placeholder="200000"/></Field>
                      <Field label="هالك (اختياري)"><Input type="number" value={purchaseForm.loss} onChange={(e)=>setPurchaseForm(f=>({...f,loss:e.target.value}))} placeholder="0"/></Field>
                      <Field label="ملاحظات (اختياري)"><Input value={purchaseForm.notes} onChange={(e)=>setPurchaseForm(f=>({...f,notes:e.target.value}))} placeholder="اختياري"/></Field>

                      <div className="sm:col-span-2 lg:col-span-4">
                        <Button onClick={addPurchase}><Icon name="plus" size={18}/> حفظ الاستلامة</Button>
                      </div>
                    </div>
                  </Card>

                  <Card>
                    <div className="flex items-center justify-between gap-3 flex-wrap">
                      <div className="font-black text-slate-900">الاستلامات</div>
                      <div className="text-xs text-slate-500 font-bold">اسحب يمين/شمال على الموبايل</div>
                    </div>
                    <div className="mt-3 overflow-auto">
                      <table className="min-w-[980px] w-full text-right">
                        <thead className="bg-slate-50 text-slate-600 text-sm">
                          <tr>
                            <th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">المعمل</th><th className="p-3">المنتج</th>
                            <th className="p-3">الكمية</th><th className="p-3">هالك</th><th className="p-3">سعر</th><th className="p-3">إجمالي</th>
                            {currentUser.role==="admin" ? (<><th className="p-3">مدفوع</th><th className="p-3">متبقي علينا</th></>) : null}
                            <th className="p-3">سجّلها</th>
                          </tr>
                        </thead>
                        <tbody>
                          {purchases.map(p => (
                            <tr key={p.id} className="border-t border-slate-100">
                              <td className="p-3"><SmallBtn className="text-red-600" onClick={()=>removeRow("purchase", p.id)}><Icon name="trash" size={18}/></SmallBtn></td>
                              <td className="p-3 font-bold">{p.date}</td>
                              <td className="p-3 font-black">{p.supplier}</td>
                              <td className="p-3 font-bold">{p.product}</td>
                              <td className="p-3 font-bold">{formatQty(p.quantity)} <span className="text-slate-400 text-xs">{productUnit(p.product)}</span></td>
                              <td className="p-3 font-black text-orange-700">{formatQty(p.loss)}</td>
                              <td className="p-3 font-bold">{formatMoney(p.buyPrice)} ج</td>
                              <td className="p-3 font-black">{formatMoney(p.total)} ج</td>
                              {currentUser.role==="admin" ? (
                                <>
                                  <td className="p-3 font-black text-emerald-700">{formatMoney(p.paid)} ج</td>
                                  <td className="p-3 font-black text-red-700">{formatMoney(p.debt)} ج</td>
                                </>
                              ) : null}
                              <td className="p-3 text-slate-500 font-black">{p.createdBy || "-"}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {activeTab==="sales" && (
                <div className="space-y-4">
                  <Card>
                    <div className="font-black text-slate-900 flex items-center gap-2"><Icon name="truck" size={18}/> تسجيل بيع</div>
                    {err.sale && <Notice variant="warn"><div className="font-black">{err.sale}</div></Notice>}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-3">
                      <Field label="التاريخ"><Input type="date" value={saleForm.date} onChange={(e)=>setSaleForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="العميل">
                        <Select value={saleForm.customer} onChange={(e)=>setSaleForm(f=>({...f,customer:e.target.value}))}>
                          {customers.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="الموزع">
                        <Select value={saleForm.driver} onChange={(e)=>setSaleForm(f=>({...f,driver:e.target.value}))}>
                          {drivers.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="المنتج">
                        <Select value={saleForm.product} onChange={(e)=>setSaleForm(f=>({...f,product:e.target.value}))}>
                          {products.map(p => <option key={p.id} value={p.name}>{p.name} (متاح: {formatQty(stockByProduct[p.name]||0)} {p.unit})</option>)}
                        </Select>
                      </Field>
                      <Field label={`الكمية (${productUnit(saleForm.product)})`}><Input type="number" value={saleForm.quantity} onChange={(e)=>setSaleForm(f=>({...f,quantity:e.target.value}))} placeholder="4000"/></Field>
                      <Field label="سعر البيع / وحدة"><Input type="number" step="0.01" value={saleForm.sellPrice} onChange={(e)=>setSaleForm(f=>({...f,sellPrice:e.target.value}))} placeholder="27"/></Field>
                      <Field label="المحصل"><Input type="number" step="0.01" value={saleForm.paid} onChange={(e)=>setSaleForm(f=>({...f,paid:e.target.value}))} placeholder="80000"/></Field>
                      <Field label="ملاحظات (اختياري)"><Input value={saleForm.notes} onChange={(e)=>setSaleForm(f=>({...f,notes:e.target.value}))} placeholder="اختياري"/></Field>

                      <div className="sm:col-span-2 lg:col-span-4">
                        <Button variant="success" onClick={addSale}><Icon name="plus" size={18}/> تسجيل البيع</Button>
                      </div>
                    </div>
                  </Card>

                  <Card>
                    <div className="flex items-center justify-between gap-3 flex-wrap">
                      <div className="font-black text-slate-900">المبيعات</div>
                      <div className="text-xs text-slate-500 font-bold">اسحب يمين/شمال على الموبايل</div>
                    </div>
                    <div className="mt-3 overflow-auto">
                      <table className="min-w-[980px] w-full text-right">
                        <thead className="bg-slate-50 text-slate-600 text-sm">
                          <tr>
                            <th className="p-3">حذف</th><th className="p-3">التاريخ</th><th className="p-3">العميل</th><th className="p-3">الموزع</th><th className="p-3">المنتج</th>
                            <th className="p-3">الكمية</th><th className="p-3">سعر</th><th className="p-3">إجمالي</th><th className="p-3">محصل</th>
                            {currentUser.role==="admin" ? <th className="p-3">آجل</th> : null}
                            <th className="p-3">سجّلها</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sales.map(s => (
                            <tr key={s.id} className="border-t border-slate-100">
                              <td className="p-3"><SmallBtn className="text-red-600" onClick={()=>removeRow("sale", s.id)}><Icon name="trash" size={18}/></SmallBtn></td>
                              <td className="p-3 font-bold">{s.date}</td>
                              <td className="p-3 font-black">{s.customer}</td>
                              <td className="p-3 font-bold">{s.driver}</td>
                              <td className="p-3 font-bold">{s.product}</td>
                              <td className="p-3 font-bold">{formatQty(s.quantity)} <span className="text-slate-400 text-xs">{productUnit(s.product)}</span></td>
                              <td className="p-3 font-bold">{formatMoney(s.sellPrice)} ج</td>
                              <td className="p-3 font-black">{formatMoney(s.total)} ج</td>
                              <td className="p-3 font-black text-emerald-700">{formatMoney(s.paid)} ج</td>
                              {currentUser.role==="admin" ? <td className="p-3 font-black text-orange-700">{formatMoney(s.debt)} ج</td> : null}
                              <td className="p-3 text-slate-500 font-black">{s.createdBy || "-"}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              )}

              {activeTab==="expenses" && (
                <div className="space-y-4">
                  <Card>
                    <div className="font-black text-slate-900 flex items-center gap-2"><Icon name="receipt" size={18}/> تسجيل مصروف</div>
                    {err.expense && <Notice variant="warn"><div className="font-black">{err.expense}</div></Notice>}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-3">
                      <Field label="التاريخ"><Input type="date" value={expenseForm.date} onChange={(e)=>setExpenseForm(f=>({...f,date:e.target.value}))}/></Field>
                      <Field label="نوع المصروف"><Input value={expenseForm.category} onChange={(e)=>setExpenseForm(f=>({...f,category:e.target.value}))} placeholder="بنزين/كارتة..."/></Field>
                      <Field label="الموزع (اختياري)">
                        <Select value={expenseForm.driver} onChange={(e)=>setExpenseForm(f=>({...f,driver:e.target.value}))}>
                          <option value="">-</option>
                          {drivers.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="المبلغ"><Input type="number" step="0.01" value={expenseForm.amount} onChange={(e)=>setExpenseForm(f=>({...f,amount:e.target.value}))} placeholder="400"/></Field>
                      <Field label="ملاحظات (اختياري)" className="lg:col-span-3"><Input value={expenseForm.notes} onChange={(e)=>setExpenseForm(f=>({...f,notes:e.target.value}))} placeholder="اختياري"/></Field>
                      <div className="lg:col-span-1">
                        <Button variant="danger" onClick={addExpense}><Icon name="plus" size={18}/> حفظ المصروف</Button>
                      </div>
                    </div>
                  </Card>
                </div>
              )}

              {activeTab==="receipts" && (
                <div className="space-y-4">
                  <Notice variant="info"><div className="font-black">اعمل إيصال لـ Alamal Group باختيار التاريخ + العميل.</div></Notice>

                  <Card>
                    <div className="font-black text-slate-900 flex items-center gap-2"><Icon name="printer" size={18}/> إصدار إيصال</div>
                    {receiptErr && <Notice variant="warn"><div className="font-black">{receiptErr}</div></Notice>}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mt-3">
                      <Field label="التاريخ"><Input type="date" value={receiptDate} onChange={(e)=>setReceiptDate(e.target.value)} /></Field>
                      <Field label="العميل">
                        <Select value={receiptCustomer} onChange={(e)=>setReceiptCustomer(e.target.value)}>
                          {customers.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="الموزع (اختياري)">
                        <Select value={receiptDriver} onChange={(e)=>setReceiptDriver(e.target.value)}>
                          <option value="">الكل</option>
                          {drivers.map(d => <option key={d.id} value={d.name}>{d.name}</option>)}
                        </Select>
                      </Field>
                      <Field label="ملاحظات (اختياري)"><Input value={receiptNotes} onChange={(e)=>setReceiptNotes(e.target.value)} placeholder="اختياري" /></Field>

                      <div className="sm:col-span-2 lg:col-span-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <Button onClick={buildReceipt}><Icon name="receipt" size={18}/> إنشاء معاينة</Button>
                        <Button variant="success" onClick={printReceipt} disabled={!receiptPreview}><Icon name="printer" size={18}/> طباعة</Button>
                        <Button variant="secondary" onClick={()=>{setReceiptPreview(null);setReceiptErr("");}}>مسح</Button>
                      </div>
                    </div>
                  </Card>
                </div>
              )}

              {activeTab==="settings" && (
                <div className="space-y-4">
                  <Card>
                    <div className="font-black text-slate-900 flex items-center gap-2"><Icon name="settings" size={18}/> الإعدادات</div>
                    <Notice variant="info">
                      <div className="font-black">
                        ✅ الموظف: <span className="underline">علي عبدالله</span> (username: <b>ali</b>) صلاحياته: <b>إدخال بيانات فقط</b>.
                        <div className="text-xs text-blue-900/70 font-bold mt-1">
                          تنبيه: ده نظام LocalStorage (بدون سيرفر). للأمان الحقيقي نحتاج Back-end + حسابات حقيقية.
                        </div>
                      </div>
                    </Notice>

                    {currentUser.role==="admin" && (
                      <div className="mt-4">
                        <h4 className="font-black text-slate-900 mb-2">تغيير PIN</h4>
                        {err.admin && <Notice variant="warn"><div className="font-black">{err.admin}</div></Notice>}
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                          <Field label="المستخدم">
                            <Select value={pinEdit.username} onChange={(e)=>setPinEdit(p=>({...p,username:e.target.value}))}>
                              {users.map(u => <option key={u.id} value={u.username}>{u.username} — {u.displayName}</option>)}
                            </Select>
                          </Field>
                          <Field label="PIN جديد"><Input value={pinEdit.newPin} onChange={(e)=>setPinEdit(p=>({...p,newPin:e.target.value}))} inputMode="numeric" placeholder="مثال: 7788"/></Field>
                          <div className="flex items-end"><Button onClick={changePin}>حفظ</Button></div>
                        </div>
                      </div>
                    )}
                  </Card>
                </div>
              )}

              {currentUser.role!=="admin" && ["dashboard","products","settlements"].includes(activeTab) && (
                <Card><Notice variant="warn"><div className="font-black">ممنوع الدخول لهذه الشاشة. صلاحياتك: إدخال بيانات فقط.</div></Notice></Card>
              )}
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
